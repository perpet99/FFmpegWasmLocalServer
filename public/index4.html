<html>
    <head>
        <style>
            div {
                border:1px solid;
                align-content: center;
            }
            div.title {
                font-size: 25px;
                text-align: center;
            }
            div.title>span {
                color: red;
            }
            div>div.global-controls{
                display: inline-block;
            }
            .play_speed {
                display: inline-block;
                padding: 5px;
                text-align: center;
            }
            .controls {
                display: inline-block;
                padding: 5px;
                text-align: center;
            }
            .showMap > iframe {
                width: 600px;
                height: 450px;
            }
            video {
                width: 600px;
                height: 450px;
            }
            table tr td {
                border:1px solid;
                text-align: center;
            }
            textarea {
                width: 100%;
            }
            div.readme {
                padding: 5px;
            }
            code {
                background:lightgrey
            }
        </style>
    </head>
    <body>
        <div>
            <div>
                
                <h3>MENU,Tesla dashcam video converter</h3>

                <a href="./index.html">1. add date to video file</a>
                <br>
                <a href="./index2.html">2. merge video file</a>
                <br>
                <a href="./index3.html">3. Concatenate mp4 Files</a>

                <h3>TeslaCam Viewer</h3>
            </div>

            <div>
                <strong>Select TeslaCam Directory</strong>(Must be in same directory as Index.html):<br/> 
                <input type="file" id="fileBrowser" accept="video/mp4" webkitdirectory multiple/>
                <!-- <button id="selectFolderBtn">Select Folder</button> -->
                <h2>Some browsers may show an additional security prompt verifying you trust the site before "uploading". Files are not uploaded</h2>
            </div>
            <div>   
                Browse Loaded Clips: <select class="date-select"><option>- - - - - -</option></select>
            </div>
        </div>
        
        <div class="global-controls">
            <div class="play_speed">
                <span>Play Speed</span><br/>
                <button onclick="playRate(0.5)">0.5x</button>
                <button onclick="playRate(1)">1x</button>
                <button onclick="playRate(2)">2x</button>
                <button onclick="playRate(3)">3x</button>
                <button onclick="playRate(8)">8x</button>
            </div>
            <div class="controls">
                <span>General Controls</span><br/>
                <button class="previous">&lt;&lt;PREV&lt;&lt;</button>
                <button class="skip" onclick="skipTo(-5)">-5</button>
                <button class="skip" onclick="skipTo(-3)">-3</button>
                <button onclick="playPause()">PLAY/PAUSE</button>
                <button class="skip" onclick="skipTo(3)">3</button>
                <button class="skip" onclick="skipTo(5)">5</button>
                <button class="next">&gt;&gt;NEXT&gt;&gt;</button>
                <input checked type="checkbox" name="autoplay"/>Autoplay
            </div>
        </div>
		<div>
            <div class="title">
                <span>No Videos Loaded</span>
            </div>
            <table>
                <tr>
                    <td><video class="left_repeater"  src="" controls controlsList="play pause"></video>
                        
                    </td>
                    <td><video class="front"          src="" controls controlsList="play pause"></video></td>
                    <td><video class="right_repeater" src="" controls controlsList="play pause"></video></td>
                </tr>
                <tr>
                    <td>
                        <button class="skip" style="height: 40;" onclick="skipTo(5)">Add timestamp</button>    
                    </td>
                    <td>
                        <button class="skip" onclick="skipTo(5)">5</button>    
                    </td>

                    <td>
                        <button class="skip" onclick="skipTo(5)">5</button>    
                    </td>

                </tr>
                <tr>
                    <td colspan="1" class="showMap" id="showMap"></td>
                    <td colspan="1"><video class="back" src="" controls controlsList="play pause"></video></td>
                    <td colspan="1"></td>
                </tr>
            </table> 
        </div>
        <div class="controls">
            <button class="skip" onclick="skipTo(5)">5</button>    
        </div>

        <div class="readme">
            <h2>README</h2>
            
            <a href="https://github.com/Lythinari/TeslaCamViewer">code by github</a>
            <hr/>
            <strong>Directory Placement</strong><br/>
            This <code>index.html</code> file <strong>must</strong> be at the same level as the <code>TeslaCam</code> folder which can be placed directly on the root of the USB drive.<br/>
            <strong>Example:</strong><br/>
            <code>
            Root Folder<br/>
            |- index.html<br/>
            |- TeslaCam(USB Drive Top Level Folder)<br/>
            &nbsp;&nbsp;&nbsp;|- Saved Clips<br/>
            &nbsp;&nbsp;&nbsp;|- Sentry Videos<br/>
            &nbsp;&nbsp;&nbsp;|- ...<br/>
            </code><br/>
        </div>
        <div id="map"></div>
        <script>(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
            ({key: "AIzaSyC-vZgyaZC3Vep_IQuBFM3tTubzceKlq9E", v: "weekly"});</script>
	</body>
    <script>

                // Initialize and add the map
        let map;

        async function initMap() {
        // The location of Uluru
        const position = { lat: -25.344, lng: 131.031 };
        // Request needed libraries.
        //@ts-ignore
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

        // The map, centered at Uluru
        map = new Map(document.getElementById("map"), {
            zoom: 4,
            center: position,
            mapId: "DEMO_MAP_ID",
        });

        // The marker, positioned at Uluru
        const marker = new AdvancedMarkerElement({
            map: map,
            position: position,
            title: "Uluru",
        });
        }

        //initMap();
        //console.log("init map")
      </script>


    <script  >
	var carouselIndex;
	var selectItemIndex;
	var files;
	
    var playbackRate = 1
	var playPauseFlag = true;
	
    var carousel = []
    var carouselEventFiles = []
    var title = document.querySelector("div.title")
    var backVideo = document.querySelector("video.back")
    var frontVideo = document.querySelector("video.front")
    var leftVideo = document.querySelector("video.left_repeater")
    var rightVideo = document.querySelector("video.right_repeater")
    var next = document.querySelector("button.next")
    var previous = document.querySelector("button.previous")
    var setVideos = document.querySelector("button.setVideos")

    var dateSelector = document.querySelector("select.date-select")

    var skip = document.querySelector("button.skip")


    class TeslaCamFile {
        separator = "/" //default separator(necessary? not sure)
        clipType = "SentryClip" //Recorded/SentryClip...
        triggerDate = "" // folder name doubles as the date the video clip was triggered
        clipDate = "" // transformed clip name
        clipName = "" // the clip name
        file = "" // webkit file incase we need other data
        url = ""
        keyName = ""

        constructor(file){
            this.clipName = file.name
            this.clipDate = Date.parse(this.parseToDate(file.name))
            this.getDirectories(file)
            this.url = URL.createObjectURL(file)
            //just in case we need it for the future
            this.file = file
        }

        getDirectories(file){
            this.separator = file.webkitRelativePath.replace(file.name, "").substr(-1)
            var directoryParts = file.webkitRelativePath.split(this.separator)
            this.clipType = directoryParts[1]
            this.triggerDate = directoryParts[2]
        }

        //format to ISO(sorta) - no TZ so defaults to local
        parseToDate(filename){
            let nameArry = filename.split("_");
            let dateArry = nameArry[0].split("-");
            let hourArry = nameArry[1].split("-");
            return dateArry[0]+"-"+dateArry[1]+"-"+dateArry[2]+"T"+hourArry[0]+":"+hourArry[1]+":"+hourArry[2]; 
        }

        build(){
            var filePath = "TeslaCam" + this.separator + this.clipType
            if(this.clipType != "RecentClips"){
                filePath += this.separator + this.triggerDate
            }
            var name = removeFileName(this.clipName)
            return filePath + this.separator + name
            //return filePath + this.separator + this.clipName.replace(/-back.mp4$/gm,'')
        }

        build2(){

          return this.url
        }


        buildEvent(){

            console.log(this.triggerDate)

            var filePath = "TeslaCam" + this.separator + this.clipType
            if(this.clipType != "RecentClips"){
                filePath += this.separator + this.triggerDate
            }

            return filePath + this.separator
        }
    }
	
    function removeFileName(str)
    {
      return str.replaceAll('-front.mp4','')
        .replaceAll('-back.mp4','')
        .replaceAll('-left_repeater.mp4','')
        .replaceAll('-right_repeater.mp4','') ;

    }

    function updateFileInfo(filelist,file){
        if(file.name.endsWith("-front.mp4")){
        }else if(file.name.endsWith("-back.mp4")){
        }else if(file.name.endsWith("-left_repeater.mp4")){
        }else if(file.name.endsWith("-right_repeater.mp4")){
        }else{
            return null
        }

        var keyName = removeFileName(file.name)
        var findFileInfo = null
        filelist.forEach((tcFile, index) => {
            if( tcFile.keyName == keyName){
                findFileInfo = tcFile
                return
            }

        })
        if( findFileInfo == null){
            

            findFileInfo = new TeslaCamFile(file)
            findFileInfo.keyName = keyName
            filelist.push(findFileInfo)
        }

        if(file.name.endsWith("-front.mp4")){
            findFileInfo.frontUrl = URL.createObjectURL(file)
        }

        if(file.name.endsWith("-back.mp4")){
            findFileInfo.backUrl = URL.createObjectURL(file)
        }

        if(file.name.endsWith("-left_repeater.mp4")){
            findFileInfo.leftUrl = URL.createObjectURL(file)
        }
        if(file.name.endsWith("-right_repeater.mp4")){
            findFileInfo.rightUrl = URL.createObjectURL(file)
        }

        return findFileInfo

    }



	//The following code uses webkitdirectory to get all the videos from a directory
    document.querySelector("input[type=file][id=fileBrowser]").addEventListener("change", function(e){
        var files = e.target.files
        tcFiles = []
        var eventFiles = {}
        var keyName = ""
        //get "back" files to sort from webkitRelativePath
        for (let i=0; i<files.length; i++) {
            var file = files[i]
            
            var fileInfo = updateFileInfo(tcFiles,file)


            //if(file.webkitRelativePath.endsWith("-back.mp4")){
                //var tcFile = new TeslaCamFile(file)
                //tcFiles.push(tcFile)
            //}
            
            if(file.webkitRelativePath.endsWith("event.json")){
                var start = file.webkitRelativePath.length - 30
                

                var keyName = file.webkitRelativePath.substr(start,19)
                console.log(keyName)
                eventFiles[keyName] = file
             
            }
        }
        
        //Sort the files in ascending date
        tcFiles.sort(function(a,b){
            var firstDate = a.clipDate
            var secondDate = b.clipDate
            return firstDate - secondDate
        })

        // Create dropdown for clips
        tmpDir = [] //track dir's added
        // if(document.querySelector("select.date-select") != undefined) {
        //     document.querySelector("select.date-select").remove()
        // }
        dateSelector.innerHTML = null

        tcFiles.forEach((tcFile, index) => {
            dir = tcFile.clipType+tcFile.separator+tcFile.triggerDate
            if (tcFile.clipType == "RecentClips") {
                var name = removeFileName(tcFile.clipName)
                dir = tcFile.clipType+tcFile.separator+name
            }
            
            if (!tmpDir.includes(dir)) {
                tmpDir.push(dir)
                var option = document.createElement("option")
                option.innerText = dir
                option.value = index // assume that the index is going to be the first clip for each new date.
                dateSelector.appendChild(option)
            }
        })

        carousel = tcFiles
        carouselEventFiles = eventFiles
        loadVideos(0)
    })
    dateSelector.addEventListener("change", function(e){
        carouselIndex = parseInt(e.target.options[e.target.selectedIndex].value)
        loadVideos(carouselIndex)
    })

    function loadVideos(index){
        title.innerHTML = carousel[index].build()
        backVideo.src = carousel[index].backUrl
        frontVideo.src = carousel[index].frontUrl
        leftVideo.src = carousel[index].leftUrl
        rightVideo.src = carousel[index].rightUrl



        //load the map window -> display google maps

        //backVideo.play()
        var keyname = carousel[index].triggerDate
        console.log(keyname)

        var file = carouselEventFiles[keyname]

        if (file == undefined) {
            document.querySelector("td#showMap").innerHTML = "can not find event info"
        } else{
            document.querySelector("td#showMap").innerHTML = "find event info"
        }

        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            var data = JSON.parse(contents)
            console.log("load event file")
            console.log(data)


            
            //const myLatLng = { lat: -25.344, lng: 131.036 }; 
            // The map, centered at myLatLng 
            //const map = new google.maps.Map(document.getElementById("iframe"), { zoom: 4, center: myLatLng, }); 
            // The marker, positioned at myLatLng 
            //new google.maps.Marker({ position: myLatLng, map, title: "Hello World!", });
            
            var zoom = 2000
            var iframe = document.createElement("iframe")
            iframe.src = "https://www.google.com/maps/embed?pb=!1m10!1m8!1m3!1d"+zoom+"!2d"+data.est_lon+"!3d"+data.est_lat+"!!!!!!!!!!!"
            //iframe.src = "https://www.google.com/maps/embed/v1/place?key=AIzaSyC-vZgyaZC3Vep_IQuBFM3tTubzceKlq9E"+zoom+"!2d"+data.est_lon+"!3d"+data.est_lat+"!!!!!!!!!!!"
            //iframe.src = "https://www.google.com/maps/embed/v1/place?key=AIzaSyC-vZgyaZC3Vep_IQuBFM3tTubzceKlq9E&q=Eiffel+Tower,Paris+France"
            document.querySelector("td#showMap").innerHTML = ""
            document.querySelector("td#showMap").appendChild(iframe)
        };


        reader.readAsText(file);

        //reader.readAsText(carouselEventFiles[carousel[index].buildEvent()+"event.json"]);
    }
    function test(){
        var zoom = 2000
        var iframe = document.createElement("iframe")
        //iframe.src = "https://www.google.com/maps/embed/v1/place?key=AIzaSyC-vZgyaZC3Vep_IQuBFM3tTubzceKlq9E"+zoom+"!2d"+data.est_lon+"!3d"+data.est_lat+"!!!!!!!!!!!"
        iframe.src = "https://www.google.com/maps/embed/v1/place?key=AIzaSyC-vZgyaZC3Vep_IQuBFM3tTubzceKlq9E&q=Eiffel+Tower,Paris+France"
        document.querySelector("td#showMap").innerHTML = ""
        document.querySelector("td#showMap").appendChild(iframe)
    }
    //test()

    function playVideos(){
        frontVideo.play()
        backVideo.play()
        leftVideo.play()
        rightVideo.play()

        frontVideo.playbackRate=playbackRate;
        backVideo.playbackRate=playbackRate;
        leftVideo.playbackRate=playbackRate;
        rightVideo.playbackRate=playbackRate;
    }
	
    function playRate(rate){
        playbackRate = rate
        playVideos()
    }

    function pauseVideos(){
        frontVideo.pause()
        backVideo.pause()
        leftVideo.pause()
        rightVideo.pause()
    }

	function playPause() {
        if (playPauseFlag!=true){
            playVideos()
            playPauseFlag = true;
        } else {
            pauseVideos()
            playPauseFlag = false;
        }
 	}
	
    let videos = document.querySelectorAll("video");

    function skipTo(seconds){
        videos.forEach(video => {
            video.currentTime += seconds
        })
    }

    //Add listeners for play, pause and click buttons for each video.
    videos.forEach(video => {
        video.addEventListener("play", function(e){
            console.log(e)
            playVideos()
        })

        video.addEventListener("pause", function(e){
            console.log(e)
            if(e.target.ended){
                if(document.querySelector("input[name=autoplay]").checked){
                    carouselIndex+=1
                    loadVideos(carouselIndex)
                }
            } else {
                pauseVideos()
            }
        })

        video.addEventListener("click", function(e){
            console.log(e)
            var currentTime = e.target.currentTime
            if(e.target != frontVideo) {
                frontVideo.currentTime = currentTime
            }
            if(e.target != leftVideo) {
                leftVideo.currentTime = currentTime
            }
            if(e.target != rightVideo) {
                rightVideo.currentTime = currentTime
            }
            if(e.target != backVideo) {
                backVideo.currentTime = currentTime
            }
        })

        video.addEventListener("canplaythrough", function(e){
            console.log("Can Play Through")
            if(document.querySelector("input[name=autoplay]").checked){
                playVideos()
            }
        })
    })
    
    var carouselIndex = 0

    next.addEventListener("click", function(){
        carouselIndex+=1
        loadVideos(carouselIndex)
    })

    previous.addEventListener("click", function(){
        carouselIndex-=1
        loadVideos(carouselIndex)
    })

    backVideo.addEventListener("ended", function(){
        console.log("Ended")
        if(document.querySelector("input[name=autoplay]").checked){
            carouselIndex+=1
            loadVideos(carouselIndex)
        }
    })
	
</script>
</html>