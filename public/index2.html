<html>
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-62W92WW6QZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-62W92WW6QZ');
</script>

    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    </style>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2736401220449917"
crossorigin="anonymous"></script>

  </head>
  <body>


    <h3>MENU</h3>

    <a href="./index.html">1. add date to video file</a>
    
    <h3>2. merge video file</h3>

    <hr width="100%" />

    <a href="https://www.youtube.com/watch?v=xRzQScmlwuQ">demo link</a>

    <h3>tesla dashcam file merge</h3>
    <h3>you need file select 4 files </h3>
    <h3>you can select multi file by mouse click with control key </h3>


    <form>
    <input type="file" id="uploader" multiple style="font-size:28px;">
    </form>

    <p id="message">Upload a video</p>
    
    <label for="datetime">recording date
      <input type="datetime-local"
             id="datetime"
             step="1"
             disabled = "true"
             >
    </label>


    <h3>select merge type</h3>

    <table border="1">
      <th><input type="radio" name="chk_info" value="0" checked="checked">diamond</th>
      <th><input type="radio" name="chk_info" value="1" >cross</th>
      <th><input type="radio" name="chk_info" value="2">vertical</th>
      <tr><!-- 첫번째 줄 시작 -->
          <td><img src="4.jpg" alt="Option 1"></td>
          <td><img src="5.jpg" alt="Option 2"></td>
          <td><img src="6.jpg" alt="Option 3"></td>
      </tr><!-- 첫번째 줄 끝 -->
    </table>

    
    


    <h3> </h3>

    <video width="640" height="480" id="output-video" controls></video><br/>

    
    <a id="download" style="font-size:56px;">
      download link
    </a>

    <h3> </h3>

    <input type='button' style="font-size:28px;" value='convert' id='convert' onclick='convert()'/>

    
    <p id="message2"> </p>

    <a href="mailto:perpet99@gmail.com"> developer email : perpet99@gmail.com</a>
    


    <h3>You have to wait until time is 00:00:60 sec </h3>

    <img src="2.png" alt="My Image">
   

    <h3>you can download by link</h3>

    <img src="1.png" alt="My Image">



    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/arial.ttf.js"></script>
    <script type="text/javascript">
      const message = document.getElementById('message');
      const message2 = document.getElementById('message2');
      const download = document.getElementById('download');

      const str = '2022-01-25_22-15-51-left.mp4';

          
      String.prototype.format = function() {
          var formatted = this;
          for( var arg in arguments ) {
              formatted = formatted.replace("{" + arg + "}", arguments[arg]);
          }
          return formatted;
      };


      function convertUTCDateToLocalDate(date) {
        var newDate = new Date(date.getTime() - date.getTimezoneOffset()*60*1000);
        return newDate;   
      }

      function convertUTCDateToLocalDate2(date) {
        var newDate = new Date(date.getTime() + date.getTimezoneOffset()*60*1000);
        return newDate;   
      }


      const dt = document.getElementById('datetime')

      

      dt.value = convertUTCDateToLocalDate(new Date()).toISOString().slice(0,16);
      console.log(convertUTCDateToLocalDate(new Date()).toISOString().slice(0,16))
      
      console.log(getText2(new Date(dt.valueAsNumber)))

      const date2 = convertUTCDateToLocalDate2(new Date(dt.valueAsNumber))
      console.log(getText2(date2))

      const btn = document.getElementById('convert')
      

      function init(){
        
      }

      var fileDataL
      var fileDataR
      var fileDataB
      var fileDataF

      //var dateInfo
      function show(){

      }


      
      async function convert(){

        const target = document.getElementById('convert');
        target.disabled = true;

        
        //const IN_FILE_NAME = 'video.mp4';
        const OUT_FILE_NAME = 'video2.mp4';
        
        
        var dateInfo = getText2(convertUTCDateToLocalDate2(new Date(dt.valueAsNumber)))


        //const param = 'drawtext=fontfile=arial.ttf:fontsize=24:text="' +getText(files[0].name) + '":fontcolor=white:box=1:boxcolor=0x00000000@1:x=(w-text_w)/10:y=text_h+10';
        //const param = 'drawtext=fontfile=arial.ttf:fontsize=24:text=' +getText(dateInfo) + ':rate=30:fontcolor=white:box=1:boxcolor=0x00000000@1:x=(w-text_w)/10:y=text_h+10';
        

        
        //const param = "drawtext=text=\\'sdfsdf\\':timecode=\\'09\:57\:00\:00\\':rate=30:fontfile=arial.ttf:fontsize=24:x=(w-text_w)/10:y=text_h+10";

        // const args = ['-i', IN_FILE_NAME, '-vf', `drawtext=fontfile=arial.ttf:text='Artist':fontsize=32:text='22012-06-06 time=':timecode='09:57:00:00':r=60:x=10: y=10: fontcolor=white: box=1: boxcolor=0x00000000@1`, OUT_FILE_NAME];

        //const args = ['-i', IN_FILE_NAME, '-vf', 'drawtext=fontfile=/arial.ttf:text=\'Artist\':fontcolor=blue:fontsize=24:x=(w-text_w)/2:y=(h-text_h)/2', OUT_FILE_NAME];
        const param = '  -i 1.mp4 -i 2.mp4 -i 3.mp4 -i 4.mp4 -y -filter_complex "nullsrc = size = 160x480[base];[0:v] setpts = PTS - STARTPTS, scale = 160x120[upperleft];[1:v] setpts = PTS - STARTPTS, scale = 160x120[upperright];[2:v] setpts = PTS - STARTPTS, scale = 160x120[lowerleft];[3:v] setpts = PTS - STARTPTS, scale = 160x120[lowerright];[base][upperleft] overlay = shortest = 1[tmp1];[tmp1][upperright] overlay = shortest = 1:y = 120[tmp2];[tmp2][lowerleft] overlay = shortest = 1:y = 240[tmp3];[tmp3][lowerright] overlay = shortest = 1:y = 360" -c:v h264 video2.mp4'
        //const param = ' '
        //const args = [  param, OUT_FILE_NAME];
        var args = ['-i', "1.mp4",'-i', "2.mp4",'-i', "3.mp4",'-i', "4.mp4",  param, OUT_FILE_NAME];

        //message.innerHTML = 'Writing file to MEMFS';
        
        const now = Date.now();

        console.time(`[${now}] ${dateInfo} execution time`);
        //message.innerHTML = 'Start to transcode';

        var fileList =  [{ name: "1.mp4", data: fileDataF },{ name: "2.mp4", data: fileDataL},{ name: "3.mp4", data: fileDataR },{ name: "4.mp4", data: fileDataB }]

        
        
        
        
        var type = document.querySelector('input[name="chk_info"]:checked').value;


        if( type == "0"){
          args = ["-i", "1.mp4", "-i" ,"2.mp4", "-i", "3.mp4" ,"-i", "4.mp4", "-filter_complex", 'color=c=black:size= 1920x960[base];[0:v] setpts = PTS - STARTPTS, scale = 640x480[upperleft];[1:v] setpts = PTS - STARTPTS, scale = 640x480[upperright];[2:v] setpts = PTS - STARTPTS, scale = 640x480[lowerleft];[3:v] setpts = PTS - STARTPTS, scale = 640x480[lowerright];[base][upperleft] overlay = shortest = 1:x = 640[tmp1];[tmp1][upperright] overlay = shortest = 1:y = 240[tmp2];[tmp2][lowerleft] overlay = shortest = 1:x = 1280:y = 240[tmp3];[tmp3][lowerright] overlay = shortest = 1:x=640:y = 480', '-pix_fmt', 'yuv420p','video2.mp4']
        }else if(type == "1"){
          args = ["-i", "1.mp4", "-i" ,"2.mp4", "-i", "3.mp4" ,"-i", "4.mp4", "-filter_complex", 'color=c=black:size = 1280x1440[base];[0:v] setpts = PTS - STARTPTS, scale = 640x480[upperleft];[1:v] setpts = PTS - STARTPTS, scale = 640x480[upperright];[2:v] setpts = PTS - STARTPTS, scale = 640x480[lowerleft];[3:v] setpts = PTS - STARTPTS, scale = 640x480[lowerright];[base][upperleft] overlay = shortest = 1:x = 320[tmp1];[tmp1][upperright] overlay = shortest = 1:y = 480[tmp2];[tmp2][lowerleft] overlay = shortest = 1:x = 640:y = 480[tmp3];[tmp3][lowerright] overlay = shortest = 1:x=320:y = 960', '-pix_fmt', 'yuv420p','video2.mp4']
        }else{
          args = ["-i", "1.mp4", "-i" ,"2.mp4", "-i", "3.mp4" ,"-i", "4.mp4", "-filter_complex", 'color=c=black:size = 640x1920[base];[0:v] setpts = PTS - STARTPTS, scale = 640x480[upperleft];[1:v] setpts = PTS - STARTPTS, scale = 640x480[upperright];[2:v] setpts = PTS - STARTPTS, scale = 640x480[lowerleft];[3:v] setpts = PTS - STARTPTS, scale = 640x480[lowerright];[base][upperleft] overlay = shortest = 1[tmp1];[tmp1][upperright] overlay = shortest = 1:y = 480[tmp2];[tmp2][lowerleft] overlay = shortest = 1:y = 960[tmp3];[tmp3][lowerright] overlay = shortest = 1:y = 1440', '-pix_fmt', 'yuv420p','video2.mp4']
        }


        const { file } = await runFFmpeg2(fileList, args, OUT_FILE_NAME,[],message2)

        const video = document.getElementById('output-video');
        video.src = URL.createObjectURL(new Blob([file.buffer], { type: 'video/mp4' }));

        download2(video.src,removeFileName(dateInfo)+'.mp4','download');

        console.timeEnd(`[${now}] ${dateInfo} execution time`);
      }

      function download2(dataurl, filename,name) {
        const link = document.getElementById(name);
        link.href = dataurl;
        link.download = filename;
        //link.click();
      }

      function removeFileName(str)
      {
        return str.replaceAll('-front.mp4','')
          .replaceAll('-back.mp4','')
          .replaceAll('-left_repeater.mp4','')
          .replaceAll('-right_repeater.mp4','') ;

      }



      function getText(str) {

        const text = removeFileName(str);
        console.log(text)
        const text2 = text.split('_');
        const text3 = text2[1].split('-');
        //return text2[0] + '   TIME\\=' + text3[0] + '\\:'+text3[1] +'\\:'+ text3[2]; 
        //return "\\'" + text2[0] + "   TIME=\\':timecode=" + text3[0] + '\\:'+text3[1] +'\\:'+ text3[2]; 
        console.log(text2)
        if( text2.length != 2)
          throw 'error1'

        console.log(text3)
        if( text3.length != 3)
          throw 'error2'

        return "\\'{0}  TIME=\\':timecode=\\'{1}:{2}:{3}:00\\'".format(text2[0], text3[0], text3[1],text3[2]);
      }

      function getText2(date) {

        let yyyy = date.getFullYear();

        let month = date.getMonth() + 1;
        let day = date.getDate();
        let hour = date.getHours();
        let minute = date.getMinutes();
        let second = date.getSeconds();

        month = month >= 10 ? month : '0' + month;
        day = day >= 10 ? day : '0' + day;
        hour = hour >= 10 ? hour : '0' + hour;
        minute = minute >= 10 ? minute : '0' + minute;
        second = second >= 10 ? second : '0' + second;


        return "{0}-{1}-{2}_{3}-{4}-{5}".format(yyyy,month,day,hour,minute,second);
        //return "\\'{0}-{1}-{2}  TIME=\\':timecode=\\'{3}:{4}:{5}:00\\'".format(yyyy,month,day,hour,minute,second);
    }



      //message2.innerHTML = getText(str);

        const transcode = async ({ target: { files } }) => {
        
        let fileDate = null
        
        
        try{

          

          
          
          var count = 0;

          for (let i = 0; i < files.length; i++) {
            var fi = files[i]
            var str = fi.name
            if( str.includes('-front.mp4')){
              count++;
              fileDataF = new Uint8Array(await readFromBlobOrFile(fi));
            }
            if( str.includes('-back.mp4')){
              count++;
              fileDataB = new Uint8Array(await readFromBlobOrFile(fi));
            }
            if( str.includes('-left_repeater.mp4')){
              count++;
              fileDataL = new Uint8Array(await readFromBlobOrFile(fi));
            }
            if( str.includes('-right_repeater.mp4')){
              count++;
              fileDataR = new Uint8Array(await readFromBlobOrFile(fi));
            }
          }
         
          if( count != 4){
            console.log("load faile")
            message.style.color = 'red';
            message.innerHTML = "file load fail,you need select 4 files"
            return
          }else{
            console.log("load success")
          }

          message.innerHTML = getText(files[0].name);


          let text = removeFileName(files[0].name);
          console.log(text)
          
          var text2 = text.split('_');
          var text3 = text2[0].split('-');
          var text4 = text2[1].split('-');

        
          console.log(text2[0])

          var str = "{0}-{1}-{2} {3}:{4}:{5}".format(text3[0],text3[1],text3[2],text4[0],text4[1],text4[2])
          console.log(str)

          fileDate  = new Date(str)
          
          console.log(convertUTCDateToLocalDate(fileDate).toISOString())

          dt.value = convertUTCDateToLocalDate(fileDate).toISOString().slice(0,19);

        }catch (err)
        {


            console.log(err)
          
        }
        
        //await convert(data,files[0].name)

        // console.log( getText(files[0].name));
      };

      


      document.getElementById('uploader').addEventListener('change', transcode);
    </script>
    

    <!-- <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/esm/ffmpeg-core.min.js"></script> -->

    <script src="js/ffmpeg/ffmpeg-core.js"></script>
  </body>
</html>
