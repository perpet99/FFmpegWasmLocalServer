<html>
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-62W92WW6QZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-62W92WW6QZ');
</script>

    <style>
      html, body {
        margin: 0;
        width: 100%;
        height: 100%
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    </style>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2736401220449917"
crossorigin="anonymous"></script>

  </head>
  <body>

    <h3>MENU</h3>

    
    <h3>1. add date to video file</h3>
    <a href="./index2.html">2. merge video file</a>


    <hr width="100%" />

    <a href="https://www.youtube.com/watch?v=2srRDfk6Hbk">demo link</a>

    <h3>bug fix : HW4(high resolution) mp4 file can not convert</h3>

    <h3>pc, mobile  크롬, 파이어폭스 브라우저에서만 동작합니다.(아이폰에서 테스트 안해봤어요)</h3>

    <h3>select tesla dashcam (테슬라 녹화영상 또는 카메라 영상을 선택하시면 해당 녹화 시간을 영상에 찍어줍니다)</h3>
    
    <h3>영상 변환 시간이 오래걸립니다. 영상이 로딩될때까지 기다려 주세요 (3분-4분 소요)</h3>

    <h3>날짜정보를 파일명에서 얻어 옵니다. 파일명 변경을 하시면 안됩니다 (카카오톡으로 옮기시면 파일명이 변경됩니다)</h3>

    <form>
    <input type="file" id="uploader" style="font-size:28px;">
    </form>

    <p id="message">Upload a video</p>
    
    <label for="datetime">날짜와 시간 수동 선택 가능합니다
      <input type="datetime-local"
             id="datetime"
             step="1"
             >
    </label>

    <input type='button' style="font-size:28px;" value='변환' id='convert' onclick='convert()'/>


    <h3> </h3>

    <video width="640" height="480" id="output-video" controls></video><br/>

    
    <a id="download" style="font-size:56px;">
      download link
    </a>

    
    <p id="message2"> </p>

    <a href="mailto:perpet99@gmail.com"> developer email : perpet99@gmail.com</a>
    
    

    <h3>일반적으로 아래 빨간 부분 시간이 1분이 되어야 완료가 됩니다.</h3>

    <img src="2.png" alt="My Image">
   

    <h3>변환이 완료된 후 아래처럼 빨간부분 아이콘을 클릭해서 다운받으세요.</h3>

    <img src="1.png" alt="My Image">

    <h3>아래처럼 찍혀서 나옵니다.</h3>

    <img src="3.png" alt="My Image">


    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/arial.ttf.js"></script>
    <script type="text/javascript">
      const message = document.getElementById('message');
      const message2 = document.getElementById('message2');
      const download = document.getElementById('download');

      const str = '2022-01-25_22-15-51-left.mp4';

          
      String.prototype.format = function() {
          var formatted = this;
          for( var arg in arguments ) {
              formatted = formatted.replace("{" + arg + "}", arguments[arg]);
          }
          return formatted;
      };


      function convertUTCDateToLocalDate(date) {
        var newDate = new Date(date.getTime() - date.getTimezoneOffset()*60*1000);
        return newDate;   
      }

      function convertUTCDateToLocalDate2(date) {
        var newDate = new Date(date.getTime() + date.getTimezoneOffset()*60*1000);
        return newDate;   
      }


      const dt = document.getElementById('datetime')

      

      dt.value = convertUTCDateToLocalDate(new Date()).toISOString().slice(0,16);
      console.log(convertUTCDateToLocalDate(new Date()).toISOString().slice(0,16))
      
      console.log(getText2(new Date(dt.valueAsNumber)))

      const date2 = convertUTCDateToLocalDate2(new Date(dt.valueAsNumber))
      console.log(getText2(date2))

      const btn = document.getElementById('convert')
      

      function init(){
        
      }

      var fileData
      //var dateInfo
      function show(){

      }


      
      async function convert(){

        const IN_FILE_NAME = 'video.mp4';
        const OUT_FILE_NAME = 'video2.mp4';
        
        
        var dateInfo = getText2(convertUTCDateToLocalDate2(new Date(dt.valueAsNumber)))


        //const param = 'drawtext=fontfile=arial.ttf:fontsize=24:text="' +getText(files[0].name) + '":fontcolor=white:box=1:boxcolor=0x00000000@1:x=(w-text_w)/10:y=text_h+10';
        const param = 'scale=1280:960,drawtext=fontfile=arial.ttf:fontsize=24:text=' +getText(dateInfo) + ':rate=30:fontcolor=white:box=1:boxcolor=0x00000000@1:x=(w-text_w)/10:y=text_h+10';
        

        
        //const param = "drawtext=text=\\'sdfsdf\\':timecode=\\'09\:57\:00\:00\\':rate=30:fontfile=arial.ttf:fontsize=24:x=(w-text_w)/10:y=text_h+10";

        // const args = ['-i', IN_FILE_NAME, '-vf', `drawtext=fontfile=arial.ttf:text='Artist':fontsize=32:text='22012-06-06 time=':timecode='09:57:00:00':r=60:x=10: y=10: fontcolor=white: box=1: boxcolor=0x00000000@1`, OUT_FILE_NAME];

        //const args = ['-i', IN_FILE_NAME, '-vf', 'drawtext=fontfile=/arial.ttf:text=\'Artist\':fontcolor=blue:fontsize=24:x=(w-text_w)/2:y=(h-text_h)/2', OUT_FILE_NAME];
        const args = ['-i', IN_FILE_NAME, '-vf', param,  OUT_FILE_NAME];

        //message.innerHTML = 'Writing file to MEMFS';
        
        const now = Date.now();
        console.time(`[${now}] ${dateInfo} execution time`);
        //message.innerHTML = 'Start to transcode';
        const { file } = await runFFmpeg2([{ name: IN_FILE_NAME, data: fileData }], args, OUT_FILE_NAME, [{ name: 'arial.ttf', data: b64ToUint8Array(ARIAL_TTF) }],message2)
        const video = document.getElementById('output-video');
        video.src = URL.createObjectURL(new Blob([file.buffer], { type: 'video/mp4' }));

        download2(video.src,removeFileName(dateInfo)+'.mp4','download');

        console.timeEnd(`[${now}] ${dateInfo} execution time`);
      }

      function download2(dataurl, filename,name) {
        const link = document.getElementById(name);
        link.href = dataurl;
        link.download = filename;
        //link.click();
      }

      function removeFileName(str)
      {
        return str.replaceAll('-front.mp4','')
          .replaceAll('-back.mp4','')
          .replaceAll('-left_repeater.mp4','')
          .replaceAll('-right_repeater.mp4','') ;

      }



      function getText(str) {

        const text = removeFileName(str);
        console.log(text)
        const text2 = text.split('_');
        const text3 = text2[1].split('-');
        //return text2[0] + '   TIME\\=' + text3[0] + '\\:'+text3[1] +'\\:'+ text3[2]; 
        //return "\\'" + text2[0] + "   TIME=\\':timecode=" + text3[0] + '\\:'+text3[1] +'\\:'+ text3[2]; 
        console.log(text2)
        if( text2.length != 2)
          throw 'error1'

        console.log(text3)
        if( text3.length != 3)
          throw 'error2'

        return "\\'{0}  TIME=\\':timecode=\\'{1}:{2}:{3}:00\\'".format(text2[0], text3[0], text3[1],text3[2]);
      }

      function getText2(date) {

        let yyyy = date.getFullYear();

        let month = date.getMonth() + 1;
        let day = date.getDate();
        let hour = date.getHours();
        let minute = date.getMinutes();
        let second = date.getSeconds();

        month = month >= 10 ? month : '0' + month;
        day = day >= 10 ? day : '0' + day;
        hour = hour >= 10 ? hour : '0' + hour;
        minute = minute >= 10 ? minute : '0' + minute;
        second = second >= 10 ? second : '0' + second;


        return "{0}-{1}-{2}_{3}-{4}-{5}".format(yyyy,month,day,hour,minute,second);
        //return "\\'{0}-{1}-{2}  TIME=\\':timecode=\\'{3}:{4}:{5}:00\\'".format(yyyy,month,day,hour,minute,second);
    }



      //message2.innerHTML = getText(str);

        const transcode = async ({ target: { files } }) => {
        
        let fileDate = null
        
        
        try{

          

          fileData = new Uint8Array(await readFromBlobOrFile(files[0]));
        
          dateInfo = files[0].name

          message.innerHTML = getText(files[0].name);


          let text = removeFileName(files[0].name);
          console.log(text)
          
          var text2 = text.split('_');
          var text3 = text2[0].split('-');
          var text4 = text2[1].split('-');

        
          console.log(text2[0])

          var str = "{0}-{1}-{2} {3}:{4}:{5}".format(text3[0],text3[1],text3[2],text4[0],text4[1],text4[2])
          console.log(str)

          fileDate  = new Date(str)
          
          console.log(convertUTCDateToLocalDate(fileDate).toISOString())

          dt.value = convertUTCDateToLocalDate(fileDate).toISOString().slice(0,19);



        }catch (err)
        {

       

          
        }

        try{
          if( !fileDate ){
            let fileName = files[0].name
            let yy = fileName.substr(0,4)
            let mm = fileName.substr(4,2)
            let dd = fileName.substr(6,2)

            let h = fileName.substr(9,2)
            let m = fileName.substr(11,2)
            let s = fileName.substr(13,2)
            
            var str = "{0}-{1}-{2} {3}:{4}:{5}".format(yy,mm,dd,h,m,s)
            console.log(str)

            fileDate  = new Date(str)
            
            console.log(fileDate.toString())

            dt.value = convertUTCDateToLocalDate(fileDate).toISOString().slice(0,19);


          }

        }catch (err){
          console.log(err)
          message.style.color = 'red';
          message.innerHTML = '날짜 정보를 파일명에서 얻어오지 못했습니다.! 직접 날짜를 선택해 주세요.';

          var dd  = new Date()
          
          console.log(dd.toString())

          dt.value = convertUTCDateToLocalDate(dd).toISOString().slice(0,16);

        }

        
        //await convert(data,files[0].name)

        // console.log( getText(files[0].name));
      };

      


      document.getElementById('uploader').addEventListener('change', transcode);
    </script>
    

    <script src="js/ffmpeg/ffmpeg-core.js"></script>
  </body>
</html>
